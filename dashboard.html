<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Stellest AI</title>
    <style>
        :root{--bg:#000;--panel:#111;--field:#1a1a1a;--text:#fff;--muted:#aaa;--border:#333;--accent:#fff;--success:#28a745;--warn:#ffc107;--danger:#dc3545}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
        .header{background:#111;border-bottom:1px solid var(--border);padding:16px 0;position:sticky;top:0;z-index:10}
        .container{max-width:1200px;margin:0 auto;padding:0 20px}
        .row{display:flex;justify-content:space-between;align-items:center}
        .logo{font-weight:800}
        .nav a{color:#fff;text-decoration:none;margin-left:12px}
        .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px;padding:20px}
        .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:hidden}
        .card h3{padding:14px 16px;border-bottom:1px solid var(--border)}
        .card .body{padding:16px}
        .info{padding:16px;color:var(--muted)}
        .btn{display:inline-block;background:#fff;color:#000;border:none;border-radius:10px;padding:10px 14px;font-weight:700;text-decoration:none}
        canvas{background:#0d0d0d;border-radius:12px}
        .footer{border-top:1px solid var(--border);padding:20px 0;text-align:center;color:var(--muted)}
    </style>
</head>
<body>
    <header class="header">
        <div class="container row">
            <div class="logo">ðŸ”¬ Stellest AI â€” Dashboard</div>
            <nav class="nav">
                <a href="/">Home</a>
                <a href="/dashboard">Dashboard</a>
                <a href="/signin" id="signoutLink">Sign out</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div id="noData" class="info" style="display:none">No prediction data found. Make a prediction on the Home page first.</div>
        <div id="summary" class="info" style="display:none"></div>
        <div class="grid" id="charts" style="display:none">
            <div class="card">
                <h3>Overall Probability</h3>
                <div class="body"><canvas id="probChart" height="220"></canvas></div>
            </div>
            <div class="card">
                <h3>Individual Models</h3>
                <div class="body"><canvas id="modelsChart" height="220"></canvas></div>
            </div>
            <div class="card">
                <h3>Risk Profile</h3>
                <div class="body"><canvas id="riskChart" height="220"></canvas></div>
            </div>
            <div class="card">
                <h3>Population Comparison</h3>
                <div class="body"><canvas id="popChart" height="220"></canvas></div>
            </div>
            <div class="card">
                <h3>Clinical Recommendation & Risk Factors</h3>
                <div class="body" id="clinicalPanel"></div>
            </div>
        </div>
        <div class="card" id="historyCard" style="display:none;margin:0 20px 20px">
            <h3>Recent Predictions</h3>
            <div class="body">
                <div style="margin-bottom:12px">
                    <button class="btn" id="exportBtn">Export CSV</button>
                </div>
                <div style="overflow:auto">
                    <table id="historyTable" style="width:100%;border-collapse:collapse">
                        <thead>
                            <tr>
                                <th style="text-align:left;border-bottom:1px solid #333;padding:8px">Time</th>
                                <th style="text-align:left;border-bottom:1px solid #333;padding:8px">Patient</th>
                                <th style="text-align:left;border-bottom:1px solid #333;padding:8px">Probability</th>
                                <th style="text-align:left;border-bottom:1px solid #333;padding:8px">Confidence</th>
                                <th style="text-align:left;border-bottom:1px solid #333;padding:8px">Recommendation</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">Developed by <a href="https://gokulakrishnan.dev" target="_blank" style="color:#fff">Gokulakrishnan</a></div>
    </footer>

    <script src="/supabase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script>
        // Optional signout via Supabase
        document.getElementById('signoutLink').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                if (window.SUPABASE_CONFIG && window.supabase) {
                    const supa = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                    await supa.auth.signOut();
                }
            } catch {}
            localStorage.removeItem('stellest_token');
            localStorage.removeItem('stellest_user');
            window.location.replace('/signin');
        });

        function getConfidenceColor(level){
            const l = (level||'').toLowerCase();
            if(l==='high') return '#28a745';
            if(l==='medium') return '#ffc107';
            return '#dc3545';
        }

        function percentileOf(value, arr){
            if(!arr || arr.length===0) return null;
            const sorted = [...arr].sort((a,b)=>a-b);
            let count = 0; for(const v of sorted){ if(v <= value) count++; }
            return Math.round((count/sorted.length)*100);
        }

        function renderPopulationComparison(prob, cohort){
            const values = cohort && cohort.length? cohort : [0.45,0.52,0.6,0.58,0.63,0.41,0.7,0.55,0.62,0.49,0.57,0.59];
            const mean = Math.round((values.reduce((a,b)=>a+b,0)/values.length)*100)/100;
            const perc = percentileOf(prob, values) || 50;
            const ctx = document.getElementById('popChart');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Cohort Mean','You'],
                    datasets: [{
                        label: 'Probability',
                        data: [Math.round(mean*100), Math.round(prob*100)],
                        backgroundColor: ['#666','#4e9eff']
                    }]
                },
                options: {plugins:{legend:{labels:{color:'#fff'}}}, scales:{y:{ticks:{color:'#fff'}, suggestedMax:100}, x:{ticks:{color:'#fff'}}}}
            });
            return { mean, percentile: perc };
        }

        function renderClinicalPanel(result, pop){
            const el = document.getElementById('clinicalPanel');
            const rf = result.risk_factors || {high_risk:[], medium_risk:[], protective:[]};
            el.innerHTML = `
                <div style="margin-bottom:12px">
                    <div><strong>Population mean:</strong> ${(pop.mean*100).toFixed(1)}%</div>
                    <div><strong>Your percentile:</strong> ${pop.percentile}th</div>
                </div>
                <div style="margin-bottom:12px"><strong>Recommendation:</strong><br/>${result.recommendation || ''}</div>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
                    <div>
                        <div style="color:#dc3545;font-weight:700;margin-bottom:6px">High Risk</div>
                        <ul>${(rf.high_risk||[]).map(x=>`<li>${x}</li>`).join('')||'<li>None</li>'}</ul>
                    </div>
                    <div>
                        <div style="color:#ffc107;font-weight:700;margin-bottom:6px">Medium Risk</div>
                        <ul>${(rf.medium_risk||[]).map(x=>`<li>${x}</li>`).join('')||'<li>None</li>'}</ul>
                    </div>
                    <div>
                        <div style="color:#28a745;font-weight:700;margin-bottom:6px">Protective</div>
                        <ul>${(rf.protective||[]).map(x=>`<li>${x}</li>`).join('')||'<li>None</li>'}</ul>
                    </div>
                </div>
            `;
        }

        function renderCharts(result){
            const charts = document.getElementById('charts');
            const summary = document.getElementById('summary');
            charts.style.display = 'grid';
            summary.style.display = 'block';

            const name = result.patient_name || 'Patient';
            const p = result.ensemble_prediction || result;
            summary.innerHTML = `
                <div style="margin:12px 0">
                    <div><strong>Patient:</strong> ${name}</div>
                    <div><strong>Probability:</strong> ${(p.probability*100).toFixed(1)}% â€” <span style="color:${getConfidenceColor(p.confidence)}">${p.confidence} confidence</span></div>
                    <div><strong>Recommendation:</strong> ${result.recommendation || (p.will_benefit?'Recommended':'Consider alternatives')}</div>
                </div>`;

            // Overall probability (doughnut)
            const probCtx = document.getElementById('probChart');
            new Chart(probCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Benefit probability', 'Remainder'],
                    datasets: [{
                        data: [Math.round(p.probability*100), 100-Math.round(p.probability*100)],
                        backgroundColor: [getConfidenceColor(p.confidence),'#222'],
                        borderColor: ['#000','#000']
                    }]
                },
                options: {plugins:{legend:{labels:{color:'#fff'}}}}
            });

            // Individual models (bar)
            const models = result.individual_models || {};
            const labels = Object.keys(models).map(m=>m.replace(/_/g,' ').replace(/\b\w/g, s=>s.toUpperCase()));
            const values = Object.values(models).map(v=>Math.max(0, Math.min(100, Math.round((v.probability||0)*100))));
            const modelsCtx = document.getElementById('modelsChart');
            new Chart(modelsCtx, {
                type: 'bar',
                data: {labels, datasets:[{label:'Probability %', data: values, backgroundColor:'#4e9eff'}]},
                options: {scales:{x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}, suggestedMax:100}}, plugins:{legend:{labels:{color:'#fff'}}}}
            });

            // Risk profile (stacked bar)
            const rf = result.risk_factors || {high_risk:[], medium_risk:[], protective:[]};
            const riskCtx = document.getElementById('riskChart');
            new Chart(riskCtx, {
                type: 'bar',
                data: {
                    labels: ['Risk Factors'],
                    datasets: [
                        {label:'High', data:[rf.high_risk.length], backgroundColor:'#dc3545'},
                        {label:'Medium', data:[rf.medium_risk.length], backgroundColor:'#ffc107'},
                        {label:'Protective', data:[rf.protective.length], backgroundColor:'#28a745'}
                    ]
                },
                options: {plugins:{legend:{labels:{color:'#fff'}}}, scales:{x:{stacked:true, ticks:{color:'#fff'}}, y:{stacked:true, ticks:{color:'#fff'}}}}
            });

            // Population comparison
            const pop = renderPopulationComparison(p.probability, null);
            renderClinicalPanel(result, pop);
        }

        function toCsv(rows){
            return rows.map(r=>r.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\n');
        }

        async function fetchHistory(){
            try{
                if(!(window.SUPABASE_CONFIG && window.supabase)) return null;
                const supa = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                const { data, error } = await supa.from('predictions').select('*').order('created_at', { ascending:false }).limit(50);
                if(error) throw error;
                return data||[];
            }catch(e){
                console.warn('Supabase history skipped:', e && e.message ? e.message : e);
                return null;
            }
        }

        function renderTable(rows){
            if(!rows || rows.length===0){
                document.getElementById('historyCard').style.display='none';
                return;
            }
            document.getElementById('historyCard').style.display='block';
            const tbody = document.querySelector('#historyTable tbody');
            tbody.innerHTML='';
            rows.forEach(r=>{
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="border-bottom:1px solid #222;padding:8px">${new Date(r.created_at||Date.now()).toLocaleString()}</td>
                    <td style="border-bottom:1px solid #222;padding:8px">${r.patient_name||''}</td>
                    <td style="border-bottom:1px solid #222;padding:8px">${r.probability!=null ? (r.probability*100).toFixed(1)+'%':''}</td>
                    <td style="border-bottom:1px solid #222;padding:8px">${r.confidence||''}</td>
                    <td style="border-bottom:1px solid #222;padding:8px">${r.recommendation||''}</td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('exportBtn').onclick = () => {
                const header = ['Time','Patient','Probability','Confidence','Recommendation'];
                const rowsCsv = rows.map(r=>[
                    new Date(r.created_at||Date.now()).toISOString(),
                    r.patient_name||'',
                    r.probability!=null ? (r.probability*100).toFixed(1)+'%':'',
                    r.confidence||'',
                    r.recommendation||''
                ]);
                const csv = toCsv([header, ...rowsCsv]);
                const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'predictions.csv'; a.click();
                URL.revokeObjectURL(url);
            };
        }

        async function loadData(){
            const raw = localStorage.getItem('last_prediction');
            if(raw){
                try{ renderCharts(JSON.parse(raw)); }catch{}
            }
            const history = await fetchHistory();
            if(!raw && (!history || history.length===0)){
                document.getElementById('noData').style.display='block';
            }
            renderTable(history||[]);
        }

        loadData();
    </script>
</body>
</html>
