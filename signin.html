<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In - Stellest AI</title>
    <style>
        :root{--bg:#000;--panel:#111;--field:#1a1a1a;--text:#fff;--muted:#aaa;--border:#333;--accent:#fff}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
        .card{width:100%;max-width:420px;background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:24px}
        h1{font-size:1.75rem;margin-bottom:8px}
        p{color:var(--muted);margin-bottom:24px}
        .field{display:flex;flex-direction:column;gap:8px;margin-bottom:16px}
        label{font-weight:600}
        input{background:var(--field);border:1px solid var(--border);border-radius:10px;color:var(--text);padding:12px;font-size:1rem}
        input:focus{outline:none;border-color:var(--accent)}
        .btn{width:100%;background:var(--accent);color:var(--bg);border:none;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}
        .btn:disabled{opacity:.6;cursor:not-allowed}
        .row{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
        a{color:var(--accent);text-decoration:none}
        .error{color:#ff7272;margin-top:12px;display:none}
        .logo{font-weight:800;margin-bottom:16px}
        .or{display:flex;align-items:center;gap:12px;margin:16px 0;color:var(--muted)}
        .or span{flex:0 0 auto}
        .or .line{height:1px;background:var(--border);flex:1}
        .gbtn{display:flex;align-items:center;justify-content:center;gap:10px;background:#fff;color:#111;border:1px solid #444;border-radius:10px;padding:12px 16px;width:100%;font-weight:700;cursor:pointer}
        .gbtn img{width:20px;height:20px}
    </style>
</head>
<body>
    <div class="card">
        <div class="logo">ðŸ”¬ Stellest AI</div>
        <h1>Welcome back</h1>
        <p>Sign in to continue to the prediction platform.</p>
        <form id="signinForm">
            <div class="field">
                <label for="email">Email</label>
                <input id="email" name="email" type="email" required placeholder="you@example.com" />
            </div>
            <div class="field">
                <label for="password">Password</label>
                <input id="password" name="password" type="password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
            </div>
            <button class="btn" id="signinBtn" type="submit">Sign in</button>
            <div class="or"><div class="line"></div><span>or</span><div class="line"></div></div>
            <button type="button" id="googleBtn" class="gbtn">
                <img alt="Google" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" />
                Continue with Google
            </button>
            <div class="row">
                <span style="color:var(--muted);font-size:.95rem">No account?</span>
                <a href="/signup">Create one</a>
            </div>
            <div id="error" class="error">Invalid credentials</div>
        </form>
    </div>

    <script src="/supabase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        if (localStorage.getItem('stellest_token')) {
            window.location.replace('/');
        }

        const form = document.getElementById('signinForm');
        const btn = document.getElementById('signinBtn');
        const err = document.getElementById('error');
        const gbtn = document.getElementById('googleBtn');

        const supabaseConfig = window.SUPABASE_CONFIG;
        let supabaseClient = null;
        if (supabaseConfig && window.supabase) {
            supabaseClient = window.supabase.createClient(supabaseConfig.url, supabaseConfig.anonKey);
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            err.style.display = 'none';
            btn.disabled = true; btn.textContent = 'Signing in...';

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            if (!email || !password) {
                err.textContent = 'Enter email and password';
                err.style.display = 'block';
                btn.disabled = false; btn.textContent = 'Sign in';
                return;
            }

            try {
                if (!supabaseClient) throw new Error('Supabase not configured');
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                const session = data.session;
                localStorage.setItem('stellest_token', session.access_token);
                localStorage.setItem('stellest_user', JSON.stringify({ email, provider: 'password' }));
                window.location.replace('/');
            } catch (e) {
                console.error(e);
                err.textContent = e.message || 'Sign-in failed';
                err.style.display = 'block';
                btn.disabled = false; btn.textContent = 'Sign in';
            }
        });

        gbtn.addEventListener('click', async () => {
            err.style.display = 'none';
            gbtn.disabled = true; gbtn.textContent = 'Connecting to Google...';
            try {
                if (!supabaseClient) throw new Error('Supabase not configured');
                const { data, error } = await supabaseClient.auth.signInWithOAuth({ provider: 'google' });
                if (error) throw error;
                // For PKCE flow, Supabase will redirect; for popup, we could handle result.
                // Here we assume redirect; if data.url is present, navigate to it.
                if (data && data.url) {
                    window.location.href = data.url;
                    return;
                }
            } catch (e) {
                console.error(e);
                err.textContent = e.message || 'Google sign-in failed';
                err.style.display = 'block';
            } finally {
                gbtn.disabled = false; gbtn.textContent = 'Continue with Google';
            }
        });
    </script>
</body>
</html>
